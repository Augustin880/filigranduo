<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Filigran Duo - Edit Performances</title>
<style>
  body {
    font-family: 'Roboto', sans-serif;
    background: #0b0b0e;
    color: #e8e8e8;
    padding: 2rem;
  }
  h1 { text-align: center; margin-bottom: 2rem; }
  .performance { 
    border: 1px solid #b18aff; 
    border-radius: 8px; 
    padding: 1rem; 
    margin-bottom: 1rem; 
    display: flex; 
    gap: 1rem; 
    align-items: center;
  }
  .performance input { flex: 1; padding: 0.5rem; border-radius: 4px; border: none; }
  .performance button { background: #b18aff; color: #0b0b0e; border: none; padding: 0.5rem 1rem; cursor: pointer; border-radius: 4px; }
  #add-btn, #update-btn { margin-top: 1rem; padding: 0.75rem 1.5rem; background: #b18aff; color: #0b0b0e; border: none; cursor: pointer; border-radius: 4px; }
</style>
</head>
<body>

<h1>Edit Performances</h1>

<div id="performances-container"></div>

<button id="add-btn">Add Performance</button>
<button id="update-btn">Save Changes</button>

<script>
  // ----- SECURITY: redirect if not logged in -----
  async function checkSession() {
    const res = await fetch('check_session.php', { credentials: 'same-origin' });
    const data = await res.json();
    if (!data.logged_in) {
      alert('Please log in first');
      window.location.href = '.';
    }
  }

  let performances = [];
  let imageOptions = [];

  // ----- LOAD IMAGE OPTIONS -----
  async function loadImages() {
    try {
      const res = await fetch('list_images.php', { credentials: 'same-origin' });
      if (!res.ok) throw new Error('Failed to load image list');
      const data = await res.json();
      imageOptions = data.images || [];
    } catch (err) {
      console.error('Failed to load images:', err);
    }
  }

  // ----- LOAD JSON FROM SERVER -----
  async function loadPerformances() {
    try {
      const res = await fetch('get_performances.php', { credentials: 'same-origin' });
      if (!res.ok) throw new Error('Failed to load performances');
      const data = await res.json();
      performances = data.performances;
      renderPerformances();
    } catch (err) {
      console.error(err);
      alert('Failed to load performances');
    }
  }

  // ----- RENDER -----
  function renderPerformances() {
    const container = document.getElementById('performances-container');
    container.innerHTML = '';
    performances.forEach((p, index) => {
      const div = document.createElement('div');
      div.className = 'performance';

      const optionsHtml = imageOptions.map(img => `
        <option value="/img/${img}" ${p.image === "/img/" + img ? "selected" : ""}>${img}</option>
      `).join('');

      div.innerHTML = `
        <input type="text" value="${p.title}" placeholder="Title">
        <input type="text" value="${p.description}" placeholder="Description">
        <input type="text" value="${p.date}" placeholder="Date">
        <input type="text" value="${p.link}" placeholder="Link">
        <select>${optionsHtml}</select>
        <button class="delete-btn">âœ–</button>
      `;

      const inputs = div.querySelectorAll('input');
      inputs[0].addEventListener('input', e => performances[index].title = e.target.value);
      inputs[1].addEventListener('input', e => performances[index].description = e.target.value);
      inputs[2].addEventListener('input', e => performances[index].date = e.target.value);
      inputs[3].addEventListener('input', e => performances[index].link = e.target.value);

      const select = div.querySelector('select');
      select.addEventListener('change', e => performances[index].image = e.target.value);

      div.querySelector('.delete-btn').addEventListener('click', () => {
        performances.splice(index, 1);
        renderPerformances();
      });

      container.appendChild(div);
    });
  }

  // ----- ADD NEW -----
  document.getElementById('add-btn').addEventListener('click', () => {
    performances.push({ title: "", description: "", date: "", link: "", image: "" });
    renderPerformances();
  });

  // ----- SAVE TO SERVER -----
  async function savePerformances() {
    try {
      const res = await fetch('save_performances.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ performances })
      });
      const data = await res.json();
      if (res.ok && data.ok) {
        alert('Performances saved successfully!');
      } else {
        console.error(data);
        alert('Failed to save performances. Check console.');
      }
    } catch (err) {
      console.error(err);
      alert('Failed to save performances');
    }
  }

  document.getElementById('update-btn').addEventListener('click', savePerformances);

  // ----- INIT -----
  (async function init() {
    await checkSession();
    await loadImages();
    await loadPerformances();
  })();
</script>

</body>
</html>
